# CloudFormation Template - SmartCampus (com rota pública)

AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Infraestrutura AWS para a Plataforma SmartCampus com Subnet pública, Internet Gateway e painel acessível.

Resources:

  SmartCampusVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: SmartCampusVPC

  SmartCampusInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: SmartCampusIGW

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref SmartCampusVPC
      InternetGatewayId: !Ref SmartCampusInternetGateway

  SmartCampusRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SmartCampusVPC
      Tags:
        - Key: Name
          Value: SmartCampusRouteTable

  DefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref SmartCampusRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref SmartCampusInternetGateway

  SmartCampusSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SmartCampusVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: SmartCampusSubnet

  AssociateRouteTable:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SmartCampusSubnet
      RouteTableId: !Ref SmartCampusRouteTable

  SmartCampusSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow Streamlit and SSH
      VpcId: !Ref SmartCampusVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8501
          ToPort: 8501
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: SmartCampusSG

  SmartCampusInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0c02fb55956c7d316 # Ubuntu 22.04 LTS
      SubnetId: !Ref SmartCampusSubnet
      SecurityGroupIds:
        - !Ref SmartCampusSG
      Tags:
        - Key: Name
          Value: SmartCampusInstance
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          sudo apt update
          sudo apt install -y python3-pip git
          pip3 install streamlit grpcio grpcio-tools
          git clone https://github.com/brumelido/plataforma-smartcampuss.git
          cd plataforma-smartcampuss/painel
          nohup streamlit run painel.py &